{% extends "backend/base.html" %}

{% load static %}

{% block title %}
Testing
{% endblock title %}


{% block styles %}
<style>

</style>
{% endblock styles %}


{% block scripts %}

<script src="https://static.opentok.com/v2/js/opentok.js"></script>
<script>

    // credentials
    var apiKey = '{{ api_key }}';
    var sessionId = '{{ session_id }}';
    var token = '{{ token }}';
    console.log("Helloo")

    // Handling all of our errors here by alerting them
    function handleError(error) {
        if (error) {
            alert(error.message);
        }
    }

    var session = OT.initSession(apiKey, sessionId);

    // Create a publisher
    var publisher = OT.initPublisher('publisher', {
        insertMode: 'append',
        width: '100%',
        height: '100%',
        facingMode: '{{ facing_mode }}'
    }, handleError);


    // Connect to the session
    session.connect(token, function (error) {
        // If the connection is successful, publish to the session
        if (error) {
            handleError(error);
        } else {
            console.log("publishing")
            session.publish(publisher, handleError);
        }
    });

    publisher.on("streamCreated", function (event) {
        console.log("Stream Started.");
    });

    publisher.on("streamDestroyed", function (event) {
        console.log("Stream stopped. Reason: " + event.reason);
    });

    session.on("streamDestroyed", function (event) {
        console.log("Stream stopped. Reason: " + event.reason);
    });


</script>
{% endblock scripts %}

{% block content %}





<div class="row justify-content-center" style="padding: 3rem 0px 3rem 0px;">
    <div class="col-lg-8 col-md-12 col-12">

        <div class="kt-portlet kt-portlet--mobile">
            <div class="kt-portlet__body" style="margin:20px;">

                <div class="row justify-content-center" style="padding-bottom: 30px;">
                    <div class="col-md-10">
                        <h1>Get Ready.</h1>
                        <p style="margin-bottom: 0px;">Please allow access to your camera and microphone.</p>
                        <p>If everything looks good continue into your virtual event.</p>
                    </div>
                </div>

                <div class="row justify-content-center" style="padding-bottom: 30px;">
                    <div class="col-md-10">
                        <div id="publisher" style="height: 400px;"></div>
                    </div>
                </div>

                <form method="POST">{% csrf_token %}
                <div class="row justify-content-center" style="padding-bottom: 30px;">
                    <div class="col-md-10">
                        <p>If you are using a mobile phone you may choose a different camera.</p>
                        {% if facing_mode == 'environment' %}
                            <a class="btn btn-info" href="{{ event.get_create_live_user_view }}">Switch To Front Camera</a>
                            <input type="hidden" id="facing_mode" name="facing_mode" value="{{ facing_mode }}">
                        {% else %}
                            <a class="btn btn-info" href="{{ event.get_create_live_environment_view }}">Switch To Rear Camera</a>
                            <input type="hidden" id="facing_mode" name="facing_mode" value="{{ facing_mode }}">
                        {% endif %}
                    </div>
                </div>
                <div class="row justify-content-center" style="padding-bottom: 30px;">
                    <div class="col-md-10">
                        <button type="submit" name="create" value="create" class="btn btn-block btn-primary">Continue</button>
                    </div>
                </div>
                </form>

            </div>
        </div>
    </div>
</div>

{% endblock content %}