{% extends "backend/base.html" %}

{% load static %}

{% block title %}
Order #{{ order.id }} | {{ event.title }}
{% endblock title %}

{% block page_title %}
<a style="text-decoration: none;font-size: 0.7em;color: #4499d5;" href="{{ event.list_orders_view }}"><i style="font-size: 1em;" class="fas fa-long-arrow-alt-left"></i> Back To Orders</a>
{% endblock page_title %}

{% block styles %}
<style type="text/css">
	.row-padder {
		padding-top: 15px;
		padding-bottom: 15px;
	}
</style>
{% endblock styles %}


{% block scripts %}
{% endblock scripts %}

{% block content %}
<style>
.dashboard-links {
	color: #7396b0;
}
</style>

<div class="row align-items-center h-100" style="padding: 3rem 0px 3rem 0px;">
	<div class="col-lg-10 offset-lg-1 col-md-12 col-12">
		<div class="kt-portlet kt-portlet--mobile">
			<div class="kt-portlet__body">
				<div class="row">
					<div class="col-12">
						<h4>Order Details</h4>
						<p>Order placed on {{ order.created_at }}</p>
						<p style="font-weight:500;">
							{% if order.failed %}
								<span style="color:#FF4500;"> Order Failed</span>
							{% elif order.partial_refund %}
								<span style="color:#FFBE00;"> This order has been partially refunded</span>
							{% elif order.refunded %}
								<span style="color:#FF4500;"> This order has been refunded</span>
							{% else %}
								<span style="color:#2584C7;">Successful Order {% if order.house_created %}- Created by House{% endif %}</span>
							{% endif %}
						</p>
						
					</div>
				</div>

				<div class="row">
					<div class="col-12">
						<p><span style="font-weight:500;">Order ID</span> | {{ order.id }}</p>
					</div>
				</div>

				<div class="row">
					<div class="col-md-4">
						<p><span style="font-weight:500;">Name</span> | {{ order.name|title }}</p>
					</div>
					<div class="col-md-8">
						<p><span style="font-weight:500;">Email</span> | {{ order.email }}</p>
					</div>
				</div>

				<div class="row">
					<div class="col-md-4">
						<p><span style="font-weight:500;">Payment Card</span> | {% include "events/orders/brands.html" with order=order.transaction %}</p>
					</div>
					<div class="col-md-4">
						<p><span style="font-weight:500;">Last Four Digits</span> | {% if order.transaction.last_four %}{{ order.transaction.last_four }}{% else %}No Payment{% endif %}</p>
					</div>
					<div class="col-md-4">
						<p><span style="font-weight:500;">Outcome</span> | {% if order.transaction.outcome_type %}{{ order.transaction.outcome_type|title }}{% else %}No Payment{% endif %}</p>
					</div>
				</div>

				{% if order.failed %}
				{% else %}
				<div class="row" style="padding-top: 40px;">
					<div class="col-12">
						<h4>Attendees</h4>
					</div>
				</div>

				<form method="POST">{% csrf_token %}
				<div class="row text-center">
					<div class="col-12">
						<table class="table table-bordered table-hover" width="100%">
							<tbody>
								{% for attendee in attendees %}
								<tr>
									<td style="vertical-align: inherit;"><p style="margin:0 auto;">{{ forloop.counter }}</p></td>
									<td style="vertical-align: inherit;"><p style="margin:0 auto;">{{ attendee.ticket }}</p></td>
									<td style="vertical-align: inherit;"><a href="{{ attendee.get_attendee_view }}"><p style="margin:0 auto;">{{ attendee.name }}</p></a></td>
									{% if order.event_cart.pay %}
										{% if attendee.active %}
											{% if attendee.ticket.price <= house_balance.balance %}
												<td><button type="submit" name="Refund" value="{{ attendee.id }}" class="btn btn-warning btn-block">Refund</button></td>
											{% else %}
												{% if attendee.ticket.free %}
												<td style="vertical-align: inherit;"><p style="margin:0 auto;color:#FFBE00;">Free Ticket</p>
												</td>
												{% else %}
												<td style="vertical-align: inherit;"><p style="margin:0 auto;color:#FFBE00;">Refund Not Available</p></td>
												{% endif %}
											{% endif %}
										{% else %}
										<td style="vertical-align: inherit;"><p style="margin:0 auto;color:#FF4500;">Refunded</p></td>
										{% endif %}
									{% endif %}
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
				
				{% if not order.house_created %}
					{% if active_attendees.count > 1  and order.event_cart.total <= house_balance.balance %}
					<div class="row">
						<div class="col-12">
							<button type="submit" name="Full Refund" value="Full Refund" class="btn btn-outline-danger btn-block">Refund Entire Order</button>
						</div>
					</div>
					{% endif %}
				{% endif %}

				</form>

				<div class="row" style="padding-top: 50px;">
					<div class="col-12">
						<h4>Order Breakdown</h4>
					</div>
				</div>

				<div class="row" style="padding-top:10px;">
					<div class="col-md-12">
						<table class="table">
							<thead class="thead-light">
								<tr>
									<th>Ticket</th>
									<th>Price</th>
									<th>Quantity</th>
									<th>Total</th>
								</tr>
							</thead>
							<tbody>
								{% if not order.event_cart.pay %}
									{% for cart_item in event_cart_items %}
									<tr>
										<td style="color: grey;">{{ cart_item.ticket.title }}</td>
										<td style="color: grey;">$0.00</td>
										<td style="color: grey;">{{ cart_item.quantity }}</td>
										<td style="color: #2584C7;">$0.00</td>
									</tr>
									{% endfor %}
									<tr>
										<td></td>
										<td></td>
										<td>
											<p style="color: grey;">Total charged to customer</p>
										</td>
										<td>
											<p style="color: grey;">$0.00</p>
										</td>
									</tr>
									<tr>
										<td></td>
										<td></td>
										<td>
											<p style="color: grey;">Payment &amp; processing fee</p>
										</td>
										<td>
											<p style="color: grey;">$0.00</p>
										</td>
									</tr>
									<tr>
										<td></td>
										<td></td>
										<td>
											<p style="color: grey;">Total payout to you</p>
										</td>
										<td>
											<p style="color: #2584C7;">$0.00</p>
										</td>
									</tr>
								{% else %}
									{% for cart_item in event_cart_items %}
									<tr>
										<td style="color: grey;">{{ cart_item.ticket.title }}</td>
										<td style="color: grey;">${{ cart_item.ticket_price }}</td>
										<td style="color: grey;">{{ cart_item.quantity }}</td>
										<td style="color: #2584C7;">+${{ cart_item.cart_item_total }}</td>
									</tr>
									{% endfor %}
									<tr>
										<td></td>
										<td></td>
										<td><p style="color: grey;">Total charged to customer</p></td>
										<td><p style="color: grey;">${{ order.event_cart.total }}</p></td>
									</tr>
									<tr>
										<td></td>
										<td></td>
										<td><p style="color: grey;">Payment &amp; processing fee</p></td>
										<td><p style="color: grey;">${{ order.event_cart.total_fee }}</p></td>
									</tr>
									<tr>
										<td></td>
										<td></td>
										<td><p style="color: grey;">Total payout to you</p></td>
										<td><p style="color: #2584C7;">${{ order.event_cart.total_no_fee }}</p></td>
									</tr>
								{% endif %}
								
								{% if event_order_refunds %}
								<tr>
									<td style="font-weight: 600;">Refunds</td>
									<td></td>
									<td></td>
									<td></td>
								</tr>
								
								{% for event_order_refund in event_order_refunds %}
								<tr>
									<td>{{ event_order_refund.attendee.ticket.title }} ({{ event_order_refund.attendee.name }})</td>
									<td>${{ event_order_refund.attendee.ticket_buyer_price }}</td>
									<td>1</td>
									<td style="color: #FF4500;">-${{ event_order_refund.refund.amount }}</td>
								</tr>
								{% endfor %}
								<tr>
									<td></td>
									<td></td>
									<td>
										<p style="color: grey;">Total payout to you</p>
									</td>
									<td>
										<p style="color: #2584C7;">${{ total_payout }}</p>
									</td>
								</tr>
								{% endif %}
							</tbody>
						</table>
					</div>
				</div>
				{% endif %}
			</div>
		</div>		
	</div>
</div>
{% endblock content %}














