{% extends "frontend/base.html" %}
{% load static %}
{% load checkout_form_tags %}

{% block title %}
{{ postcard.name }}
{% endblock title %}


{% block page_description %}
<meta name="description" content="{{ postcard.description|safe|striptags }}">
<meta property="og:image" content="{{ postcard.image_1.url }}">

<meta property="og:url" content="{{ request.path }}">
<meta name="twitter:card" content="{{ postcard.slug }}">
{% endblock page_description %}


{% block styles %}
<style>
iframe {
    width: 100%;
    min-height: 0px;
    border: none;
}


.slider[data-paging="true"]:not(section) .flickity-page-dots {
    bottom: -30px;
}
</style>


{% endblock styles %}

{% block top_page_scripts %}
<script src="https://js.stripe.com/v3/"></script>

{% endblock top_page_scripts %}


{% block scripts %}
<script>

var clientSecret = '{{ client_secret }}';

var stripe = Stripe('{{ public_key }}');
var paymentRequest = stripe.paymentRequest({
    country: 'CA',
    currency: 'cad',
    total: {
        label: '{{ postcard.name }}',
        amount: 500,
    },
    requestPayerName: true,
    requestPayerEmail: true,
});


var elements = stripe.elements();
var prButton = elements.create('paymentRequestButton', {
    paymentRequest: paymentRequest,
    style: {
        paymentRequestButton: {
            type: 'default',
            // One of 'default', 'book', 'buy', or 'donate'
            // Defaults to 'default'

            theme: 'light-outline',
            // One of 'dark', 'light', or 'light-outline'
            // Defaults to 'dark'

            height: '40px'
            // Defaults to '40px'. The width is always '100%'.
        },
    },
});


// Check the availability of the Payment Request API first.
paymentRequest.canMakePayment().then(function (result) {
    if (result) {
        console.log("Hellooo is the payment accepted");
        prButton.mount('#payment-request-button');
    } else {
        document.getElementById('payment-request-button').style.display = 'none';
    }
});


// // Check the availability of the Payment Request API first.
// paymentRequest.canMakePayment().then(function (result) {
//     if (result) {
//         prButton.mount('#payment-request-button');
//         // document.getElementById('card-element').style.display = 'none';
//         // document.getElementById('checkout-button').style.display = 'none';

//     } else {
//         document.getElementById('payment-request-button').style.display = 'none';

//     }
// });



paymentRequest.on('paymentmethod', function (ev) {
    // Confirm the PaymentIntent without handling potential next actions (yet).

   stripe.confirmCardPayment(
        clientSecret,
        { payment_method: ev.paymentMethod.id },
        { handleActions: false }
    ).then(function (confirmResult) {
        if (confirmResult.error) {
            // Report to the browser that the payment failed, prompting it to
            // re-show the payment interface, or show an error message and close
            // the payment interface.
            console.log("Failed");
            ev.complete('fail');
        } else {
            // Report to the browser that the confirmation was successful, prompting
            // it to close the browser payment method collection interface.
            console.log("success");
            ev.complete('success');
            // Let Stripe.js handle the rest of the payment flow.
            stripe.confirmCardPayment(clientSecret).then(function (result) {
                if (result.error) {
                    // The payment failed -- ask your customer for a new payment method.
                    console.log("Failllll");
                } else {
                    // The payment has succeeded.
                    console.log("DID IT COMEEE HEEREEE")
                    stripeClientSecretHandler('{{ intent_id }}');
                }
            });
        }
    });

});

</script>


<script>

var stripe = Stripe('{{ public_key }}');
var elements = stripe.elements();

// Custom styling can be passed to options when creating an Element.
var style = {
  base: {
    color: '#303238',
    color: "#32325d",
    fontSmoothing: 'antialiased',
    '::placeholder': {
      color: '#ccc',
    },
  },
  invalid: {
    color: '#e5424d',
    ':focus': {
      color: '#303238',
    },
  },
};

// Create an instance of the card Element.
var card = elements.create('card',  {style: style});

// Add an instance of the card Element into the `card-element` <div>.
card.mount('#card-element');

card.addEventListener('change', function(event) {
  var displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
    console.log(event.error.message)
  } else {
    displayError.textContent = '';
  }
});

console.log(card);

var form = document.getElementById('donationForm');
form.addEventListener('submit', function(event) {
  event.preventDefault();

  console.log("Itt came here");



  stripe.confirmCardPayment(clientSecret, {
        payment_method: {
            card: card,
            billing_details: {
                name: document.getElementById("id_name").value,
            }
        }
    }).then(function (result) {
        if (result.error) {
            // Show error to your customer (e.g., insufficient funds)
            console.log("LETSSS GOOO")
            console.log(result)
            console.log(result.error.message);
            document.getElementById("stripe_error_row").style.display = 'block';
            document.getElementById("stripe_error").innerHTML = result.error.message;
            document.getElementById('customButton').disabled = false;

        } else {
            // The payment has been processed!
            if (result.paymentIntent.status === 'succeeded') {

                console.log("Succeed");
                stripeClientSecretHandler('{{ intent_id }}');
                // Show a success message to your customer
                // There's a risk of the customer closing the window before callback
                // execution. Set up a webhook or plugin to listen for the
                // payment_intent.succeeded event that handles any business critical
                // post-payment actions.
            }
        }
    });

});


function stripeClientSecretHandler(intent_id) {
  // Insert the token ID into the form so it gets submitted to the server
  var form = document.getElementById('donationForm');
  var hiddenInput = document.createElement('input');
  hiddenInput.setAttribute('type', 'hidden');
  hiddenInput.setAttribute('name', 'intent_id');
  hiddenInput.setAttribute('value', intent_id);
  form.appendChild(hiddenInput);

  // Submit the form
  form.submit();
  document.getElementById('customButton').disabled = true;
}
</script>


<script type="text/javascript">

    function initMap() {

        var input = document.getElementById('autocomplete');
        var autocomplete = new google.maps.places.Autocomplete(input, { types: ['address'], componentRestrictions: { country: "ca" } });

        var input2 = document.getElementById('autocomplete2');
        var autocomplete2 = new google.maps.places.Autocomplete(input2, { types: ['address'], componentRestrictions: { country: "ca" } });

    }
</script>

<script type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCnTiJMXoPzVLoo-ztKaRyCrjAocA0K3pQ&libraries=places&callback=initMap"></script>

{% endblock scripts %}



{% block content %}
<section style="padding-top: 60px;">
    <div class="container">

        <form id="donationForm" method="POST" >{% csrf_token %}

            <div class="row justify-content-center text-center" style="padding-bottom: 20px;">
                <div class="col-lg-8 col-md-10 col-sm-12 col-10">
            
                    <a href="{% url 'home' %}">
                        <img src="{% static 'images/logo.png' %}" style="max-height: 5em;">
                    </a>
            
                </div>
            </div>
            
            <div class="row justify-content-center text-center" style="padding-bottom: 30px;">
                <div class="col-lg-8 col-md-10 col-sm-12 col-10">
                    <a class="btn btn--sm btn--primary" href="{% url 'postcards:list' %}">
                        <span class="btn__text">See More Postcards</span>
                    </a>
                </div>
            </div>

            <div class="row justify-content-center" style="padding-bottom: 30px;">
                <div class="col-lg-8 col-md-10 col-sm-12 col-12" style="box-shadow: rgba(0, 0, 0, 0.2) -10px 5px 30px;padding: 40px;border-radius: 15px;">

                    {% if form.non_field_errors %}
                    <div class="row" style="padding-bottom: 20px;">
                        <div class="col-md-12">
                            <div class="alert bg--error">
                                <div class="alert__body">
                                    {% for error in form.non_field_errors %}
                                    <span>{{ error|escape }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}


                    {% if form.address.errors %}
                    <div class="row" style="padding-bottom: 20px;">
                        <div class="col-md-12">
                            <div class="alert bg--error">
                                <div class="alert__body">
                                    {% for error in form.address.errors %}
                                    <span>{{ error|escape }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}


                    <div class="row justify-content-around" style="padding-bottom: 30px;">
                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <h3 style="text-align: center;margin-bottom: 5px;">{{ postcard.name }}</h3>
                            <p class="text-center">{{ postcard.amount_sold }} postcards sold</p>
                            <div class="slider border--round boxed--border" data-paging="true" data-arrows="true" style="margin-bottom: 10px;">
                                <ul class="slides">
                                    {% if postcard.image_1 %}
                                    <li>
                                        <img alt="Image" src="{{ postcard.image_1.url }}" />
                                    </li>
                                    {% endif %}
                                    {% if postcard.image_2 %}
                                    <li>
                                        <img alt="Image" src="{{ postcard.image_2.url }}" />
                                    </li>
                                    {% endif %}
                                    {% if postcard.image_3 %}
                                    <li>
                                        <img alt="Image" src="{{ postcard.image_3.url }}" />
                                    </li>
                                    {% endif %}
                                    {% if postcard.image_4 %}
                                    <li>
                                        <img alt="Image" src="{{ postcard.image_4.url }}" />
                                    </li>
                                    {% endif %}
                                    {% if postcard.image_5 %}
                                    <li>
                                        <img alt="Image" src="{{ postcard.image_5.url }}" />
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                            <!--end slider-->
                        </div>
                    </div>
                    <div class="row justify-content-around" style="padding-bottom: 40px;">
                        <div class="col-sm-12 col-md-12 col-lg-12">
                            
                            <p style="font-size: small;">
                                {{ postcard.description|safe }}
                            </p>
                            <h3>${{ postcard.amount }}</h3>
                            <h5 style="margin-bottom:0px;">Dimensions</h5>
                            <p>5” L X 7 ”W  Premium Card Stock</p>
                        </div>
                    </div>
                    <!--end of row-->

                    <div class="row" style="padding-bottom: 10px;">
                        <div class="col-12" style="padding-bottom: 10px;">
                            <h4 style="margin-bottom: 0px;">Your Information</h4>
                            <p>We'll put the name your enter in the 'Name' 
                                field on the back of your card under your personal message unless you choose to be anonymous.
                                We ask you to enter your address so that we can add return address to the postcard, 
                                if you choose anonymous we won't include a return address.</p>
                        </div>
                    </div>

                    <div class="row" style="padding-bottom: 10px;">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-5 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Your Name <i style="color: #4399d5;font-size: 0.8em;" class="fa fa-info-circle"
                                data-tooltip="Who is the card from?"></i></p>
                            {{ form.name }}
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-7 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Your Email <i style="color: #4399d5;font-size: 0.8em;" class="fa fa-info-circle"
                                data-tooltip="We'll send you a confirmation email of your purchase here."></i></p> 
                            {{ form.email }}
                        </div>
                    </div>

                    <div class="row" style="padding-bottom: 10px;">
                        <div class="col-xl-9 col-lg-9 col-md-9 col-sm-8 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Your Address</p>
                            {{ form.address }}
                            <span style="font-size: 0.8em;">Used as the return address on the postcard unless 'anonymous' is selected</span>
                        </div>
                        <div class="col-md-3 col-sm-12 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Your Postal Code</p>
                            {{ form.postal_code }}
                        </div>
                    </div>
                    <div class="row" style="padding-bottom: 30px;">
                        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-4 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Anonymous <i style="color: #4399d5;font-size: 0.8em;" class="fa fa-info-circle"
                                data-tooltip="Switch on and we won't tell your recipient you sent the card."></i></p>
                            <div class="input-checkbox input-checkbox--switch">
                                {{ form.anonymous }}
                                <label for="checkbox-switch"></label>
                            </div>
                        </div>
                    </div>


                    <div class="row" style="padding-bottom: 10px;">
                        <div class="col-12" style="padding-bottom: 10px;">
                            <h4 style="margin-bottom: 0px;">Recipient Information</h4>
                            <p>We'll use this information to personalize your card! 
                                Please make sure the address and postal code is correct and tell us the message you'd like to write on the back of the card.</p>
                        </div>
                    </div>
                    
                    <div class="row" style="padding-bottom: 10px;">
                        <div class="col-md-12 col-sm-12 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Recipient's Name <i style="color: #4399d5;font-size: 0.8em;" class="fa fa-info-circle"
                                data-tooltip="This is the name we will place on the front of the card."></i></p>
                            {{ form.recipient_name }}
                        </div>
                    </div>

                    <div class="row" style="padding-bottom: 20px;">
                        <div class="col-md-8 col-sm-12 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Recipient's Address <i style="color: #4399d5;font-size: 0.8em;" class="fa fa-info-circle"
                                data-tooltip="Make sure you get this right :D"></i></p>
                            {{ form.recipient_address }}
                        </div>
                        <div class="col-md-4 col-sm-12 col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Postal Code</p>
                            {{ form.recipient_postal_code }}
                        </div>
                    </div>


                    <div class="row" style="padding-bottom: 30px;">
                        <div class="col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 0px;">Personalized Message To Recipient <i style="color: #4399d5;font-size: 0.8em;" class="fa fa-info-circle"
                                data-tooltip="We'll write this on the back of the card for you."></i></p>
                            {{ form.message_to_recipient }}
                        </div>
                    </div>


                    <div class="row" style="padding-bottom: 30px;display: none;" id="fee_p">
                        <div class="col-12" style="padding-bottom: 10px;">
                            <p style="margin-bottom: 5px;" class="lead">Fee | <span style="color: #4a90e2;" id="fee_amount"></span> </p>
                            <p style="margin-bottom: 5px;font-size: 10px;line-height: 1.5;color: #4a90e2;">{{ house.name }} has requested
                                it's donors pay the payment processing fees for '<span id="donation_type_name"></span>' donations.</p>
                        </div>
                    </div>

                    <div class="row justify-content-center" style="padding-bottom: 40px;">
                        <div class="col-md-12">

                            <!-- Stripe Errors -->
                            <div class="row" style="padding-bottom: 20px;display: none;" id="stripe_error_row">
                                <div class="col-md-12">
                                    <div class="alert bg--error">
                                        <div class="alert__body">
                                            <span id="stripe_error"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row justify-content-center" style="padding-bottom: 20px;">
                                <div class="col-md-12">
                                    <div id="card-element">
                                        <!-- A Stripe Element will be inserted here. -->
                                    </div>
                                </div>
                            </div>
                        
                            <div class="row justify-content-center" style="padding-bottom: 20px;">
                                <div class="col-md-12">
                                    <!-- Used to display Element errors. -->
                                    <div id="card-errors" role="alert" style="color: #e5424d;"></div>
                                </div>
                            </div>


                            <div class="row justify-content-center" id="checkout-button" style="padding-bottom: 20px;">
                                <div class="col-md-12">
                                    <button id="customButton" type="submit" class="btn btn--primary">Pay
                                        ${{ postcard.amount }} with card</button>
                                </div>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-md-12">
                                    <div id="payment-request-button">
                                        <!-- A Stripe Element will be inserted here. -->
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>


                    
            
                </div>
            </div>
            
            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10 col-sm-12 col-10">
                    <p style="font-size: 12px;line-height: 1.5;"><span style="color: #4a90e2;font-weight: 800;">Refunds |</span>
                        Please note that due to the nature of these customized postcards we do not issue refunds. However if you have any concerns at all please contact us right away.</p>
                </div>
            </div>

        </form>

    </div>
</section>
{% endblock content %}